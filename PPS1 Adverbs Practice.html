<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=yes, maximum-scale=5" />
<title>Present Perfect (A2) – Ever / Never / Already / Yet / Still</title>
<style>
  :root{
    --bg:#FDFBED;
    --ink:#222;
    --ink-soft:#555;
    --blue:#193873;
    --green:#1E8E3E;
    --accent:#961917; /* Restart / Play Again buttons */
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:"MS Reference Sans Serif", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    display:flex; align-items:center; justify-content:center;
    padding:16px;
  }
  .app{ width:min(980px,100%); display:flex; flex-direction:column; gap:8px }

  /* ===== Header & mobile title layout ===== */
  header{
    display:flex;
    align-items:flex-end;
    gap:12px;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .titleWrap{ text-align:left } /* ensure left-align by default */
  h1{ font-weight:600; margin:0; color:#000; line-height:1.2 }
  .sub{ color:var(--ink-soft); margin:0; font-size:.95rem; line-height:1.25 }
  .sub .sub-l1, .sub .sub-l2{ display:inline } /* desktop: one line */
  header h1, header .sub{ max-width:100% }
  .rightTools{ display:flex; align-items:center; gap:10px }

  @media (max-width:640px){
    header{
      flex-direction:column;
      align-items:stretch;   /* let each child align itself */
      gap:6px;
      text-align:initial;
    }
    .titleWrap{ text-align:left } /* mobile: keep heading/sub left-aligned */
    .sub .sub-l1, .sub .sub-l2{ display:block } /* split onto two lines on mobile */
    .rightTools{
      align-self:flex-end;   /* keep mute/restart to the right on mobile */
      justify-content:flex-end;
    }
  }

  /* ===== Sentence stage & animations ===== */
  .stage{
    position:relative;
    min-height:140px; /* gives room for centered end panel later */
    padding:2px 0;
    overflow:hidden;
    margin-top:80px; /* larger gap from header */
  }
  .sentence{
    margin:0;
    font-size:clamp(1.15rem, 1rem + 1.2vw, 1.8rem);
    line-height:1.25;
    text-align:center;
    font-style: italic;
    transform:translateX(-120%);
    opacity:0;
  }
  .sentence .blank{
    display:inline-block;
    min-width:6ch;
    padding:0 .35rem;
    border-bottom:1px solid #000; /* simple thin black underline */
    margin:0 .25rem;
    line-height:1;
  }
  .sentence .blank.correctWord{
    color:var(--green);
    font-weight:400; /* not bold */
  }
  .enterSentence{ animation:slideIn .45s ease-out forwards }
  .exitSentenceRight{ animation:slideOutRight .45s ease-in forwards }
  @keyframes slideIn{
    from{ transform:translateX(-120%); opacity:0 }
    to{   transform:translateX(0);     opacity:1 }
  }
  @keyframes slideOutRight{
    from{ transform:translateX(0);   opacity:1 }
    to{   transform:translateX(120%); opacity:0 }
  }

  /* ===== End panel (appears in the sentence area after animation) ===== */
  .endPanel{
    position:absolute; inset:0;
    display:none;             /* shown at end */
    align-items:center; justify-content:center;
    flex-direction:column; gap:10px;
    text-align:center;
  }
  .endPanel.show{ display:flex; }
  .finalScore{
    font-weight:700; color:#000; margin-top:4px;
  }

  /* ===== Choices ===== */
  .choices{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    opacity:0;
    margin:10px 0; /* reduced gaps above/below */
  }
  .choices.fadeIn{ animation:fadeInUp .35s ease-out .2s forwards }
  @keyframes fadeInUp{
    from{ opacity:0; transform:translateY(6px) }
    to{   opacity:1; transform:translateY(0) }
  }
  .choices button{
    appearance:none; border:none; cursor:pointer;
    padding:10px 16px; border-radius:999px;
    background:#fff; color:#000; font-weight:700;
    outline:2px solid var(--blue);   /* blue border default */
    transition:transform .08s ease, filter .15s, outline-color .15s;
  }
  .choices button:hover{ transform:translateY(-1px) }
  .choices button:active{ transform:scale(.98) }
  .choices button[disabled]{ filter:grayscale(.9); cursor:not-allowed; outline-color:#bbb; color:#777 }
  .choices .correctChoice{ outline-color:var(--green) } /* correct -> green border */

  /* ===== HUD ===== */
  .hud{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-top:8px }
  .dots{ display:flex; gap:6px }
  .dot{ width:12px; height:12px; border-radius:999px; background:#e3e3e3; border:2px solid #c9c9c9 }
  .dot.done,.dot.current{ background:#000; border-color:#000 }
  .score{ font-weight:700; color:#000 }

  /* ===== Buttons ===== */
  .btn{
    padding:10px 14px; border-radius:999px; border:2px solid var(--accent);
    background:var(--accent); color:#fff; font-weight:700; cursor:pointer
  }
  .playAgain{ margin:0 auto }

  /* Mute button: hidden until music starts after first click, then stays visible */
  .muteBtn{
    visibility:hidden;
    display:inline-flex; background:transparent; border:none; padding:6px;
    width:40px; height:40px; border-radius:999px; cursor:pointer; line-height:0;
  }
  .muteBtn img{ width:24px; height:24px; display:block; }

  /* ===== Congrats overlay (full viewport so not clipped) ===== */
  #congratsOverlay{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    z-index:9999; background:transparent; pointer-events:none;
  }
  #congratsOverlay img{
    width:clamp(180px,60%,420px); height:auto;
    animation:none; will-change: transform, opacity;
  }
  @keyframes congratsZoom{
    0%{ transform:scale(0.70); opacity:0; }
    8%{ opacity:1; }
    100%{ transform:scale(1.0); opacity:1; }
  }
</style>
</head>
<body>
  <main class="app">
    <header>
      <div class="titleWrap">
        <h1>Present Perfect – Adverbs Practice</h1>
        <p class="sub">
          <span class="sub-l1">Choose the correct adverb:</span>
          <span class="sub-l2"><strong>ever</strong>, <strong>never</strong>, <strong>already</strong>, <strong>yet</strong>, <strong>still</strong>.</span>
        </p>
      </div>
      <div class="rightTools">
        <!-- Mute on the left (becomes visible only after music starts the first time) -->
        <button class="muteBtn" id="muteBtn" aria-pressed="false" aria-label="Mute background music" title="Mute">
          <img id="muteIcon" alt="" src="https://schredder222.github.io/Assets/Unmute.svg" />
        </button>
        <!-- Restart on the right -->
        <button class="btn" id="restartBtn">Restart</button>
      </div>
    </header>

    <section class="stage">
      <p id="sentence" class="sentence"></p>

      <!-- End-of-quiz panel that shows after the celebratory image disappears -->
      <div id="endPanel" class="endPanel" aria-hidden="true">
        <button class="btn playAgain" id="playAgainBtn">Play Again</button>
        <div id="finalScore" class="finalScore"></div>
      </div>
    </section>

    <div class="choices" id="choices">
      <button type="button" data-word="ever">ever</button>
      <button type="button" data-word="never">never</button>
      <button type="button" data-word="already">already</button>
      <button type="button" data-word="yet">yet</button>
      <button type="button" data-word="still">still</button>
    </div>

    <footer class="hud" id="hud">
      <div class="dots" id="dots"></div>
      <div class="score" id="score">Score: 0 / 10</div>
    </footer>

    <!-- Overlay -->
    <div id="congratsOverlay" aria-hidden="true">
      <img src="" alt="Result">
    </div>

    <!-- SFX -->
    <audio id="sfx-correct" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_dcde83efa6.mp3?filename=ui_correct_button2-103167.mp3"></audio>
    <audio id="sfx-wrong" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b0669294aa.mp3?filename=training-program-incorrect1-88736.mp3"></audio>
    <audio id="clickSound" preload="auto" src="https://cdn.pixabay.com/download/audio/2024/04/21/audio_1b8d3bcd3d.mp3?filename=click-buttons-ui-menu-sounds-effects-button-7-203601.mp3"></audio>
    <!-- Looping background music (starts on first answer click) -->
    <audio id="bgm" preload="auto" loop src="https://cdn.pixabay.com/download/audio/2022/04/12/audio_53e27872d3.mp3"></audio>
    <audio id="applause" preload="auto" src="https://schredder222.github.io/Assets/Applause.mp3"></audio>
  </main>

<script>
(function(){
  const ITEMS = [
    { s:"Have you [blank] been to London?", a:"ever" },
    { s:"I have actually [blank] eaten sushi.", a:"never" },
    { s:"Has she finished her homework [blank]?", a:"yet" },
    { s:"He has [blank] eaten dinner, so he isn’t hungry.", a:"already" },
    { s:"I [blank] haven't seen Game of Thrones.", a:"still" },
    { s:"We have [blank] met before. Nice to meet you.", a:"never" },
    { s:"The bus [blank] hasn't come. It’s very late.", a:"still" },
    { s:"They haven’t arrived [blank].", a:"yet" },
    { s:"My friend has [blank] visited Paris, but not Rome.", a:"already" },
    { s:"Have you [blank] ridden a horse?", a:"ever" }
  ];

  const sentenceEl = document.getElementById("sentence");
  const choicesWrap = document.getElementById("choices");
  const choiceBtns = Array.from(choicesWrap.querySelectorAll("button"));
  const dotsEl = document.getElementById("dots");
  const scoreEl = document.getElementById("score");
  const hud = document.getElementById("hud");
  const restartBtn = document.getElementById("restartBtn");
  const playAgainBtn = document.getElementById("playAgainBtn");
  const endPanel = document.getElementById("endPanel");
  const finalScore = document.getElementById("finalScore");
  const sfxCorrect = document.getElementById("sfx-correct");
  const sfxWrong = document.getElementById("sfx-wrong");
  const clickSound = document.getElementById("clickSound");
  const bgm = document.getElementById("bgm");
  const applause = document.getElementById("applause");
  const overlay = document.getElementById("congratsOverlay");
  const overlayImg = overlay.querySelector("img");
  const muteBtn = document.getElementById("muteBtn");
  const muteIcon = document.getElementById("muteIcon");
  const MUTE_ICON_URL = "https://schredder222.github.io/Assets/Mute.svg";
  const UNMUTE_ICON_URL = "https://schredder222.github.io/Assets/Unmute.svg";

  let order = [];
  let idx = 0;
  let score = 0;
  let locked = false;
  let firstAttempt = true;

  /* Music control */
  let musicArmed = true;   // music starts on first answer click
  let muteShown = false;   // once shown, keep visible across restarts

  function startMusicIfArmed(){
    if(!musicArmed) return;
    try{
      bgm.volume = 0.12;
      const p = bgm.play();
      if (p?.then){
        p.then(()=>{
          if(!muteShown){
            muteBtn.style.visibility = 'visible';
            muteShown = true;
          }
          syncMuteUI();
        }).catch(()=>{ /* ignored */ });
      } else {
        if(!muteShown){
          muteBtn.style.visibility = 'visible';
          muteShown = true;
        }
        syncMuteUI();
      }
    }catch(e){}
    musicArmed = false;
  }
  function stopMusic(){ try{ bgm.pause(); }catch(e){} }
  function armMusic(){ musicArmed = true; }

  function syncMuteUI(){
    const muted = bgm.muted;
    muteBtn.setAttribute('aria-pressed', String(muted));
    muteIcon.src = muted ? MUTE_ICON_URL : UNMUTE_ICON_URL;
    muteBtn.title = muted ? "Unmute" : "Mute";
    muteBtn.setAttribute('aria-label', muted ? "Unmute background music" : "Mute background music");
  }
  muteBtn.addEventListener("click", ()=>{
    bgm.muted = !bgm.muted;
    syncMuteUI();
  });

  function shuffle(a){
    const arr=a.slice();
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function setSentence(text){
    sentenceEl.className="sentence";
    const html = text.replace("[blank]", `<span class="blank" aria-label="blank">&nbsp;</span>`);
    sentenceEl.innerHTML = html;
    requestAnimationFrame(()=> sentenceEl.classList.add("enterSentence"));
  }

  function renderDots(){
    dotsEl.innerHTML="";
    for(let i=0;i<ITEMS.length;i++){
      const d=document.createElement("span");
      let cls="dot";
      if(i < idx){ cls+=" done"; }
      else if(i === idx){ cls+=" current"; }
      d.className=cls;
      dotsEl.appendChild(d);
    }
  }

  function resetChoices(){
    choiceBtns.forEach(b=>{ b.disabled=false; b.classList.remove("correctChoice"); });
    choicesWrap.classList.remove("fadeIn");
    requestAnimationFrame(()=> choicesWrap.classList.add("fadeIn"));
    firstAttempt = true;
  }

  function next(){
    if(idx>=ITEMS.length){
      finishQuiz();
      return;
    }
    const item=ITEMS[order[idx]];
    setSentence(item.s);
    resetChoices();
    renderDots();
  }

  function init(){
    order=shuffle([...Array(ITEMS.length).keys()]);
    idx=0; score=0;
    scoreEl.textContent=`Score: ${score} / ${ITEMS.length}`;
    choicesWrap.style.opacity=1;
    choicesWrap.style.display="flex";
    overlay.style.display="none";
    endPanel.classList.remove("show");
    endPanel.setAttribute("aria-hidden","true");
    finalScore.textContent="";
    playAgainBtn.blur();
    hud.style.display="flex";
    restartBtn.style.display="inline-block";

    stopMusic();  // ensure music is stopped
    armMusic();   // will start after first answer click
    muteBtn.style.visibility = muteShown ? 'visible' : 'hidden';

    sentenceEl.style.display="";
    next();
  }

  function finishQuiz(){
    // stop the music on quiz finish
    stopMusic();

    // Hide choices & HUD while animation plays
    choicesWrap.style.display="none";
    hud.style.display="none";

    sentenceEl.innerHTML="";
    overlay.style.display="flex";
    overlayImg.style.animation="none";
    void overlayImg.offsetWidth; /* reflow to restart animation */
    overlayImg.style.animation="congratsZoom 6s ease-out forwards";

    let imgSrc="";
    if(score===10){ imgSrc="https://schredder222.github.io/Assets/Superb.png"; applause.currentTime=0; applause.play(); }
    else if(score>=7){ imgSrc="https://schredder222.github.io/Assets/Not%20Bad.png"; }
    else { imgSrc="https://schredder222.github.io/Assets/Keep%20practising.png"; }
    overlayImg.src=imgSrc;

    // After 6s: hide overlay, show Play Again centered in sentence area + centered score below
    setTimeout(()=>{
      overlay.style.display="none";
      finalScore.textContent = `Score: ${score} / ${ITEMS.length}`;
      endPanel.classList.add("show");
      endPanel.setAttribute("aria-hidden","false");
      restartBtn.style.display="none";
      // re-arm music for next run; mute button stays as-is (visible if previously shown)
      armMusic();
    },6000);
  }

  choiceBtns.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(locked||idx>=ITEMS.length) return;

      // Start music & reveal mute on the first button click only
      startMusicIfArmed();

      const guess=btn.dataset.word;
      const current=ITEMS[order[idx]];

      if(guess===current.a){
        btn.classList.add("correctChoice"); // green outline
        if(firstAttempt){ score++; }
        scoreEl.textContent=`Score: ${score} / ${ITEMS.length}`;

        const filled = current.s.replace("[blank]", `<span class="blank correctWord">${guess}</span>`);
        sentenceEl.innerHTML = filled;

        try { sfxCorrect.currentTime = 0; sfxCorrect.play(); } catch(e){}

        locked=true;
        choiceBtns.forEach(b=>{ if(b!==btn) b.disabled=true; });
        setTimeout(()=>{
          sentenceEl.classList.remove("enterSentence");
          sentenceEl.classList.add("exitSentenceRight");
          setTimeout(()=>{
            idx++;
            locked=false;
            next();
          },460);
        },1500);
      } else {
        btn.disabled=true;
        firstAttempt = false;
        try { sfxWrong.currentTime = 0; sfxWrong.play(); } catch(e){}
      }
    });
  });

  restartBtn.addEventListener("click", ()=>{
    clickSound.currentTime=0; clickSound.play();

    // Stop music immediately on restart and only resume after next answer click
    stopMusic();
    armMusic();
    muteBtn.style.visibility = muteShown ? 'visible' : 'hidden';

    locked=false; sentenceEl.className="sentence";
    choicesWrap.style.opacity=1;
    init();
  });

  playAgainBtn.addEventListener("click", ()=>{
    clickSound.currentTime=0; clickSound.play();
    init();
  });

  init();
})();
</script>
</body>
</html>
