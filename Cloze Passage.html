<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Australia's Rival Cities</title>
<style>
  :root{
    --bg:#fdfbed; --ink:#111; --accent:#8A0000; --muted:#e9e4cf;
    --ok:#2e7d32; --bad:#c62828;
    --pt:0em; --pb:.02em; --px:.12em; --yshift:.10em;
  }

  html,body{margin:0}
  body{
    font-family:"MS Reference Sans Serif","Segoe UI",Tahoma,Arial,sans-serif;
    background:var(--bg);color:var(--ink);padding:20px
  }
  .wrap{max-width:900px;margin:0 auto}
  h1{font-weight:600; font-size: 25px; margin:24px 0 10px 0; 
  }
  .passage{
    font-size:1.05rem;background:#fff;border:1px solid var(--muted);border-radius:12px;padding:16px 18px;
    position:relative;
  }
  .passage p{line-height:1.6}

  .city-image{display:block;max-width:100%;height:auto;margin:0 auto 1rem;border-radius:12px}

  /* ===== Blanks ===== */
  .blank{
    --slot-w:10ch;
    width:var(--slot-w);
    display:inline-block;vertical-align:baseline;position:relative;white-space:nowrap;
    margin:0 .18rem 0;background:#fff;border-radius:.25rem;color:#777;text-align:center;
    padding:var(--pt) var(--px) var(--pb);height:calc(1em + var(--pb));line-height:1;box-sizing:content-box;
    top:var(--yshift);touch-action:none;
  }
  .blank *{line-height:1}
  .blank .hit{position:absolute;left:-.25em;right:-.25em;top:-.60em;bottom:-.45em;background:transparent;pointer-events:none;}
  .blank.empty::after{content:"";position:absolute;left:.25em;right:.25em;height:2px;background:var(--accent);bottom:var(--pb);border-radius:2px;pointer-events:none;}
  .blank.filled::after{content:none;}

  /* Wrapper that receives correctness outline and click-selection ring */
  .fill-wrap{
    display:inline-flex;align-items:center;justify-content:center;
    width:100%;height:1em;position:relative;top:-0.10em;border-radius:.25rem;box-sizing:content-box;
  }
  .fill-wrap.correct{outline:2px solid var(--ok);}
  .fill-wrap.incorrect{outline:2px solid var(--bad);}
  .fill-wrap.selected{box-shadow:0 0 0 2px #555;} /* only when clicked-selected */

  .placing .blank{cursor:copy;}

  .blank .tile,.blank .answer-text{
    display:inline-block;border:0!important;background:transparent!important;padding:0!important;box-shadow:none!important;color:#193873;
    line-height:1;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;
  }
  .answer-text{font-weight:600;text-transform:lowercase}

  .bank{margin-top:14px;background:#fff;border:1px dashed #c9c4ac;border-radius:12px;padding:12px}
  .bank-title{font-weight:600;margin:0 0 .5rem}
  .bank-tiles{display:flex;flex-wrap:wrap;gap:.5rem;min-height:2.2rem}
  .score{margin-top:.75rem;font-weight:600}

  .tile{
    display:inline-flex;align-items:center;justify-content:center;
    padding:.35rem .6rem;border:1px solid #ccc;border-radius:.55rem;background:#fff;
    cursor:grab;white-space:nowrap;
    font-family:inherit;font-size:1.05rem;font-weight:700;text-transform:lowercase;color:#193873;
    transition:transform .08s ease,border .08s ease,background .08s ease;
    touch-action:none;-webkit-user-drag:none;
  }
  html.desktop .tile{-webkit-user-drag:element;}
  .tile:active{cursor:grabbing;transform:scale(.98)}
  .tile.selected{border:2px solid #555;background:#f9f9f9}
  /* Inside a blank, use the wrap ring, not the tile border */
  .blank .tile.selected{border:0!important;background:transparent!important}

  .controls{display:flex;gap:.5rem;margin:1rem 0 0}
  button{
    border:none;padding:10px 16px;border-radius:10px;font-weight:600;letter-spacing:.2px;cursor:pointer;
    transition:background .2s,transform .15s;font-family:inherit;
  }
  button.red{background:#8A0000;color:#fff;}
  button.red:hover{background:#a80000;transform:translateY(-1px)}
  button.red:active{background:#700000;transform:translateY(1px);box-shadow:0 2px 6px rgba(0,0,0,.2)}
  button.ghost{background:#eee;color:#111;box-shadow:none}
  button.ghost:hover{background:#ddd}
  button:disabled{opacity:.5; cursor:not-allowed; pointer-events:none;}

  .drag-ghost{
    position:fixed;left:0;top:0;transform:translate(-9999px,-9999px);
    padding:.35rem .6rem;border:1px solid #ccc;border-radius:.55rem;background:#fff;
    font:700 1.05rem "MS Reference Sans Serif","Segoe UI",Tahoma,Arial,sans-serif;
    white-space:nowrap;color:#193873;pointer-events:none;opacity:.95;z-index:9999;
  }

  /* === Congrats overlay (centred over the passage) === */
  #congratsOverlay{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    z-index:10; pointer-events:none;
  }
  #congratsOverlay img{width:min(60%,400px);height:auto;animation:none;will-change:transform,opacity;border:none;outline:none;box-shadow:none;}
  @keyframes congratsZoom{0%{transform:scale(0.70);opacity:0}8%{opacity:1}100%{transform:scale(1.0);opacity:1}}

  /* === AFL term & popup === */
  .term{border-bottom:1px dashed var(--accent);cursor:help;}
  .no-afl #aflTerm{pointer-events:none;cursor:default;}

  .passage-tip{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    z-index:12; pointer-events:none;
  }
  .passage-tip .card{
    background:#fff;border:1px solid var(--muted);border-radius:12px;
    max-width:min(560px,90%);padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.18);
    display:flex;gap:12px;align-items:flex-start;pointer-events:auto;
  }
  .passage-tip img{width:140px;height:auto;border-radius:8px;flex:0 0 auto;object-fit:cover;}
  .passage-tip .text{font-size:.98rem;line-height:1.45}
  .passage-tip .close{margin-left:auto;background:#eee;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;font-family:inherit;}
  .hidden{display:none !important;}

  @media (max-width:520px){
    .passage-tip .card{flex-direction:column;align-items:center;text-align:center}
    .passage-tip img{width:70%}
  }

  /* ---- CRISP underline for empty blanks (pixel-snapped) ---- */
  .blank.empty::after { content: none !important; }              /* turn off pseudo-line */
  .blank.empty{ box-shadow: inset 0 -2px 0 0 var(--accent); }    /* consistent 2px underline */
  .blank.filled{ box-shadow: none; }                             /* no line when filled */
</style>
</head>
<body>
  <div class="wrap">
    <h1>Australia's Rival Cities</h1>

    <img src="https://schredder222.github.io/Assets/Sydney-Melbourne.png" alt="Sydney and Melbourne" class="city-image">

    <div class="passage">
      <!-- Congrats overlay -->
      <div id="congratsOverlay" aria-hidden="true">
        <img src="https://schredder222.github.io/Assets/Love%20Your%20Work!.png" alt="Love your work!">
      </div>

      <!-- AFL info popup -->
      <div class="passage-tip" id="aflTip" aria-hidden="true" role="dialog" aria-label="What is AFL?">
        <div class="card">
          <img src="https://upload.wikimedia.org/wikipedia/commons/d/d9/Kick_for_goal_02_170525.jpg" alt="AFL player kicking for goal">
          <div class="text">
            <strong>Australian Rules Football (AFL):</strong> an Australian code of football played on an oval-shaped field with 18 players on each team.
          </div>
          <button class="close hidden" type="button" aria-label="Close">Close</button>
        </div>
      </div>

      <p>
        Have you ever visited Sydney or Melbourne? These two cities are the biggest in Australia and are known for their very different styles. Sydney is famous for the Opera House, the Harbour Bridge, and its beautiful
        <span class="blank empty" data-answer="beaches"></span>.
        Every year, many
        <span class="blank empty" data-answer="tourists"></span>
        visit to enjoy the harbour or
        <span class="blank empty" data-answer="relax"></span>
        on Bondi Beach. Melbourne, on the other hand, is well known for its culture, cafés, and sport. People enjoy visiting art galleries, watching the Australian Open tennis, or going to an <span class="term" id="aflTerm" tabindex="0" role="button" aria-controls="aflTip" aria-expanded="false">Aussie Rules (AFL) football</span> match. The two cities have had a
        <span class="blank empty" data-answer="rivalry"></span>
        since the 19th century when they both competed to be the
        <span class="blank empty" data-answer="capital"></span>
        city, and this can still be seen today in sport, business, and culture. Both cities have grown
        <span class="blank empty" data-answer="rapidly"></span>
        in the last few
        <span class="blank empty" data-answer="decades"></span>,
        and millions of people now live in each. However, Melbourne has just overtaken Sydney as Australia’s largest city, which has surprised many Australians.
      </p>
    </div>

    <div class="bank" id="bank">
      <div class="bank-title">Drag the words into the blanks (or click/tap to select):</div>
      <div class="bank-tiles" id="bankTiles"></div>
      <div class="score" id="score"></div>
    </div>

    <div class="controls">
      <button id="checkBtn" class="red">Check answers</button>
      <button id="showBtn" class="ghost">Show answers</button>
      <button id="resetBtn" class="ghost">Reset</button>
    </div>
  </div>

<script>
(function(){
  const ANSWERS=["beaches","tourists","relax","rivalry","capital","rapidly","decades"];
  const bankTiles=document.getElementById('bankTiles');
  const blanks=[...document.querySelectorAll('.blank')];
  const checkBtn=document.getElementById('checkBtn');
  const showBtn=document.getElementById('showBtn');
  const resetBtn=document.getElementById('resetBtn');
  const scoreEl=document.getElementById('score');

  const successAudio=new Audio("https://schredder222.github.io/Assets/Applause.mp3");
  const errorAudio  =new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_b0669294aa.mp3?filename=training-program-incorrect1-88736.mp3");
  const dropAudio   =new Audio("https://cdn.pixabay.com/download/audio/2025/03/20/audio_99fc376452.mp3?filename=ui-pop-sound-316482.mp3");
  const clickAudio  =new Audio("https://cdn.pixabay.com/download/audio/2024/04/21/audio_1b8d3bcd3d.mp3?filename=click-buttons-ui-menu-sounds-effects-button-7-203601.mp3");
  [successAudio,errorAudio,dropAudio,clickAudio].forEach(a=>a.preload="auto");
  const play=a=>{try{a.currentTime=0;a.play()}catch{}};

  const bigCongratsAudio = new Audio("https://cdn.pixabay.com/download/audio/2024/08/31/audio_aa510c96aa.mp3");
  bigCongratsAudio.preload = "auto";

  /* --- AFL popup controls --- */
  const term = document.getElementById('aflTerm');
  const tip  = document.getElementById('aflTip');
  const closeBtn = tip.querySelector('.close');
  let tipMode = null; // 'hover' | 'click' | null
  let aflEnabled = true;

  function setAflEnabled(on){
    aflEnabled = !!on;
    if(on){
      document.body.classList.remove('no-afl');
      term.setAttribute('aria-disabled','false');
      term.tabIndex = 0;
    }else{
      hideTip();
      document.body.classList.add('no-afl');
      term.setAttribute('aria-disabled','true');
      term.tabIndex = -1;
    }
  }

  function showTip(mode){
    if(!aflEnabled) return;
    tipMode = mode || 'hover';
    tip.style.display='flex';
    term.setAttribute('aria-expanded','true');
    if(tipMode === 'hover'){ closeBtn.classList.add('hidden'); }
    else { closeBtn.classList.remove('hidden'); }
  }
  function hideTip(){
    tip.style.display='none';
    term.setAttribute('aria-expanded','false');
    tipMode = null;
  }

  term.addEventListener('mouseenter', ()=> showTip('hover'));
  term.addEventListener('mouseleave', ()=> { if(tipMode==='hover') hideTip(); });
  term.addEventListener('focus',    ()=> showTip('hover'));
  term.addEventListener('blur',     ()=> { if(tipMode==='hover') hideTip(); });
  term.addEventListener('click', (e)=>{ e.preventDefault(); showTip('click'); });
  closeBtn.addEventListener('click', hideTip);
  document.addEventListener('click',(e)=>{
    const insideTerm = e.target.closest && e.target.closest('#aflTerm');
    const insideCard = e.target.closest && e.target.closest('#aflTip .card');
    if(!insideTerm && !insideCard && tip.style.display==='flex' && tipMode==='click'){
      hideTip();
    }
  });

  /* --- Celebration controls and button states --- */
  let celebrating = false;
  let congratsTimer = null;

  function setControlsDuringCelebration(active){
    checkBtn.disabled = active;
    showBtn.disabled  = active;
    resetBtn.disabled = false;
    checkBtn.setAttribute('aria-disabled', String(active));
    showBtn .setAttribute('aria-disabled', String(active));
    resetBtn.setAttribute('aria-disabled', 'false');
  }

  function endCelebration(){
    const ov  = document.getElementById('congratsOverlay');
    if(congratsTimer){ clearTimeout(congratsTimer); congratsTimer = null; }
    ov.style.display = 'none';
    try { bigCongratsAudio.pause(); bigCongratsAudio.currentTime = 0; } catch {}
    try { successAudio.pause();     successAudio.currentTime     = 0; } catch {}
    celebrating = false;
    setAflEnabled(true);
    setControlsDuringCelebration(false);
  }

  function showCongrats(){
    if(celebrating) return;
    const ov  = document.getElementById('congratsOverlay');
    const img = ov.querySelector('img');
    img.style.animation = 'none';
    void img.offsetWidth;
    img.style.animation = 'congratsZoom 8s ease-out forwards';
    ov.style.display = 'flex';

    celebrating = true;
    setAflEnabled(false);
    setControlsDuringCelebration(true);

    try { bigCongratsAudio.currentTime = 0; bigCongratsAudio.play(); } catch {}
    congratsTimer = setTimeout(endCelebration, 9000);
  }

  /* --- Core activity logic --- */
  const shuffle=a=>a.slice().sort(()=>Math.random()-.5);
  const findTile=word=>Array.from(document.querySelectorAll('.tile')).find(t=>t.dataset.value===word);

  const IS_COARSE = (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) || ('ontouchstart' in window);
  if(!IS_COARSE){ document.documentElement.classList.add('desktop'); }

  let selectedTile=null;

  function setPlacingMode(on){ document.body.classList.toggle('placing', !!on); }

  function clearSelections(){
    document.querySelectorAll('.tile.selected').forEach(x=>x.classList.remove('selected'));
    document.querySelectorAll('.fill-wrap.selected').forEach(x=>x.classList.remove('selected'));
  }

  function selectTile(t){
    if(!t) return;
    clearSelections();
    selectedTile=t;
    t.classList.add('selected');                  // bank tile border
    const wrap=t.closest('.fill-wrap');
    if(wrap){ wrap.classList.add('selected'); }   // placed tile ring
    setPlacingMode(true);
  }

  function deselect(){
    if(selectedTile){
      clearSelections();
      selectedTile=null;
      setPlacingMode(false);
    }
  }

  /* Create tiles */
  function makeTile(word){
    const t=document.createElement('div');
    t.className='tile';
    t.dataset.value=word; t.textContent=word;
    t.draggable = true;

    // Do NOT select on drag; also deselect any existing selection when a drag starts
    t.addEventListener('dragstart', e=>{
      deselect(); // dragging a different word clears any selection
      if(e.dataTransfer){
        e.dataTransfer.setData('text/plain', word);
        e.dataTransfer.effectAllowed = 'move';
        const img = t.cloneNode(true);
        img.style.position='absolute'; img.style.left='-9999px'; img.style.top='-9999px';
        document.body.appendChild(img);
        try{ e.dataTransfer.setDragImage(img, img.offsetWidth/2, img.offsetHeight/2); }catch{}
        setTimeout(()=>{ if(img && img.parentNode) img.parentNode.removeChild(img); }, 0);
      }
    });

    return t;
  }

  function ensureHit(blank){
    if(!blank.querySelector('.hit')){
      const hit=document.createElement('span'); hit.className='hit';
      blank.appendChild(hit);
    }
  }

  function makeEmpty(b){
    b.innerHTML=''; ensureHit(b);
    b.classList.add('empty'); b.classList.remove('filled');
  }
  function makeFilled(b,node){
    b.innerHTML=''; b.classList.remove('empty'); ensureHit(b);
    const wrap=document.createElement('span'); wrap.className='fill-wrap';
    wrap.appendChild(node); b.appendChild(wrap); b.classList.add('filled');
  }

  function initBank(){
    bankTiles.innerHTML='';
    shuffle(ANSWERS).forEach(w=>bankTiles.appendChild(makeTile(w)));

    const bank=document.getElementById('bank');
    bank.addEventListener('dragover',e=>{
      e.preventDefault();
      if(e.dataTransfer) e.dataTransfer.dropEffect='move';
    });
    bank.addEventListener('drop',e=>{
      e.preventDefault();
      const w=e.dataTransfer && e.dataTransfer.getData('text/plain');
      const t=findTile(w); if(!t) return;
      const src=t.closest('.blank'); if(src) makeEmpty(src);
      bankTiles.appendChild(t);
      play(dropAudio);
      // no selection after drag-drop to bank
    });
  }

  // placeTile: third arg says whether to keep selection after placing
  function placeTile(tile,blank, keepSelection=false){
    if(!tile||!blank) return;
    const src=tile.closest('.blank');
    const existingWrap=blank.querySelector('.fill-wrap');
    const existingTile=existingWrap?.querySelector('.tile');
    if(src===blank) return;

    if(existingTile){
      if(src){ makeFilled(src, existingTile); }
      else{ bankTiles.appendChild(existingTile); }
    }
    makeFilled(blank,tile);
    if(src && !existingTile) makeEmpty(src);

    play(dropAudio);
    if(keepSelection){
      selectTile(tile);
    }else{
      // Explicitly remove any selection ring after click-placement
      deselect();
    }
  }

  function initBlanks(){
    blanks.forEach(b=>{
      makeEmpty(b);

      /* Drag targets */
      b.addEventListener('dragover',e=>{
        e.preventDefault();
        if(e.dataTransfer) e.dataTransfer.dropEffect='move';
      });
      b.addEventListener('drop',e=>{
        e.preventDefault();
        const w=e.dataTransfer && e.dataTransfer.getData('text/plain');
        const t=findTile(w);
        placeTile(t,b,false); // never keep selection on drag placement
      });

      /* CLICK behaviour inside blanks:
         - Click a tile in this blank when none selected -> SELECT that tile.
         - Click the same selected tile -> DESELECT it.
         - Click a different blank while a tile is selected -> PLACE/SWAP selected into this blank (then deselect).
         - Click empty space in blank while a tile is selected -> PLACE into this blank (then deselect). */
      b.addEventListener('click',(e)=>{
        const clickedTile = e.target.closest && e.target.closest('.tile');
        const clickedInsideThisBlank = !!clickedTile && b.contains(clickedTile);

        if(clickedInsideThisBlank){
          if(!selectedTile){
            selectTile(clickedTile);            // select placed word
            e.stopPropagation(); return;
          }
          if(selectedTile === clickedTile){
            deselect();                         // toggle off
            e.stopPropagation(); return;
          }
          // Different tile already selected elsewhere -> swap into this blank
          placeTile(selectedTile,b,false);      // remove border after swap
          e.stopPropagation(); return;
        }

        // Clicked the blank area (not directly on its tile)
        if(selectedTile){
          placeTile(selectedTile,b,false);      // remove border after placing
          e.stopPropagation(); return;
        }
        // else: nothing selected and clicked empty area of blank -> do nothing
      });
    });
  }

  function checkAnswers(){
    let correct=0;
    blanks.forEach(b=>{
      const wrap=b.querySelector('.fill-wrap');
      if(!wrap) return;
      wrap.classList.remove('correct','incorrect');
      const t=wrap.querySelector('.tile');
      if(t){
        if(t.dataset.value===b.dataset.answer){ wrap.classList.add('correct'); correct++; }
        else { wrap.classList.add('incorrect'); }
      }
    });
    const total=blanks.length;
    scoreEl.textContent=`Score: ${correct}/${total}`;
    play(correct===total?successAudio:errorAudio);
    if(correct===total) showCongrats();
  }

  function showAnswers(){
    blanks.forEach(b=>{
      b.innerHTML=''; ensureHit(b);
      const wrap=document.createElement('span'); wrap.className='fill-wrap correct';
      wrap.innerHTML=`<span class="answer-text">${b.dataset.answer}</span>`;
      b.appendChild(wrap); b.classList.add('filled');
    });
    deselect();
    scoreEl.textContent='Answers revealed.'; setPlacingMode(false);
  }

  function resetAll(){
    if(celebrating){ endCelebration(); }
    blanks.forEach(b=>{
      const tile=b.querySelector('.fill-wrap .tile');
      if(tile) bankTiles.appendChild(tile);
      makeEmpty(b);
    });
    initBank();
    deselect();
    setPlacingMode(false);
    scoreEl.textContent='';
  }

  /* ---------- TOUCH/POINTER helpers ---------- */
  let dragging=null;
  let pendingTouch=null;
  let suppressNextClick=false;
  const TAP_DRAG_THRESHOLD=6;

  let autoScrollDir=0; let autoScrollRAF=null;
  function startAutoScrollLoop(){
    if(autoScrollRAF!=null) return;
    const tick=()=>{
      if(!dragging || autoScrollDir===0){ autoScrollRAF=null; return; }
      window.scrollBy(0, autoScrollDir*12);
      autoScrollRAF=requestAnimationFrame(tick);
    };
    autoScrollRAF=requestAnimationFrame(tick);
  }
  function stopAutoScroll(){ autoScrollDir=0; if(autoScrollRAF!=null){ cancelAnimationFrame(autoScrollRAF); autoScrollRAF=null; } }
  function setAutoScrollFromY(y){
    const margin=80, bottom=window.innerHeight-margin;
    autoScrollDir = y<margin ? -1 : (y>bottom ? 1 : 0);
    if(autoScrollDir!==0) startAutoScrollLoop(); else stopAutoScroll();
  }

  function startTouchDrag(tile,e){
    const ghost=document.createElement('div');
    ghost.className='drag-ghost'; ghost.textContent=tile.textContent; document.body.appendChild(ghost);
    tile.style.visibility='hidden';
    const rect=tile.getBoundingClientRect();
    const offsetX=e.clientX-rect.left, offsetY=e.clientY-rect.top;
    dragging={tile,ghost,offsetX,offsetY,pointerId:e.pointerId};
    // Clear any selection when a drag begins
    deselect();
    moveGhost(e.clientX,e.clientY); setAutoScrollFromY(e.clientY);
    try{ tile.setPointerCapture(e.pointerId); }catch{}
    document.body.style.touchAction='none';
  }
  function moveGhost(x,y){
    if(!dragging) return;
    const {ghost,offsetX,offsetY}=dragging;
    ghost.style.transform=`translate(${Math.round(x-offsetX)}px, ${Math.round(y-offsetY)}px)`;
  }
  function targetFromPoint(x,y){
    const {ghost}=dragging||{};
    if(ghost) ghost.style.visibility='hidden';
    const el=document.elementFromPoint(x,y);
    if(ghost) ghost.style.visibility='';
    return el;
  }
  function endTouchDrag(e){
    if(!dragging) return;
    const {tile,ghost}=dragging;
    const x=e.clientX,y=e.clientY;
    const dropTarget=targetFromPoint(x,y);
    const blank=dropTarget && dropTarget.closest && dropTarget.closest('.blank');
    const bank=dropTarget && dropTarget.closest && dropTarget.closest('#bank');
    if(blank){ placeTile(tile,blank,false); }
    else if(bank){
      const src=tile.closest('.blank'); if(src) makeEmpty(src);
      bankTiles.appendChild(tile); play(dropAudio);
    }
    tile.style.visibility=''; ghost.remove(); dragging=null;
    document.body.style.touchAction=''; stopAutoScroll();
  }

  // Click selection for tiles not inside blanks (e.g., bank), plus outside click to clear.
  document.addEventListener('click',(e)=>{
    if(suppressNextClick){ suppressNextClick=false; return; }

    // If the click happened inside a blank, that blank's handler already dealt with it.
    if(e.target.closest && e.target.closest('.blank')) return;

    let tile=e.target.closest && e.target.closest('.tile');
    if(tile){
      if(tile===selectedTile){ deselect(); return; } // toggle off
      selectTile(tile);
      return;
    }
    if(!e.target.closest('.tile, .bank, .controls')) deselect();
  });

  // Touch tap-vs-drag setup
  window.addEventListener('pointerdown',(e)=>{
    const isTouchLike=(e.pointerType && e.pointerType!=='mouse') || ('ontouchstart' in window);
    if(!isTouchLike) return;
    let tile=e.target.closest && e.target.closest('.tile');
    if(!tile){
      const wrap=e.target.closest && e.target.closest('.fill-wrap');
      if(wrap) tile=wrap.querySelector('.tile');
    }
    if(!tile) return;
    e.preventDefault();
    pendingTouch={tile,pointerId:e.pointerId,startX:e.clientX,startY:e.clientY,moved:false};
    suppressNextClick=true;
  },{passive:false});

  window.addEventListener('pointermove',(e)=>{
    if(!pendingTouch || e.pointerId!==pendingTouch.pointerId) return;
    const dx=e.clientX-pendingTouch.startX, dy=e.clientY-pendingTouch.startY;
    const movedEnough=Math.hypot(dx,dy)>TAP_DRAG_THRESHOLD;
    if(!dragging && movedEnough){ pendingTouch.moved=true; startTouchDrag(pendingTouch.tile,e); }
    else if(dragging){ e.preventDefault(); moveGhost(e.clientX,e.clientY); setAutoScrollFromY(e.clientY); }
  },{passive:false});

  window.addEventListener('pointerup',(e)=>{
    if(pendingTouch && e.pointerId===pendingTouch.pointerId){
      if(!dragging){
        // tap => delegate to normal click flow
        const el = document.elementFromPoint(e.clientX, e.clientY);
        if(el && el.closest('.blank')){ /* handled by blank click */ }
        else{
          const t = el && (el.closest('.tile') || el.closest('.fill-wrap')?.querySelector('.tile'));
          if(t){
            if(selectedTile===t){ deselect(); } else { selectTile(t); }
          }else{
            if(!el.closest('.controls') && !el.closest('.bank')) deselect();
          }
        }
      }else{
        endTouchDrag(e);
      }
      pendingTouch=null; setTimeout(()=>{ suppressNextClick=false; },0);
    }
  },{passive:false});

  window.addEventListener('pointercancel',()=>{
    pendingTouch=null; if(dragging){ document.body.style.touchAction=''; stopAutoScroll(); dragging=null; }
  });

  /* Controls */
  checkBtn.onclick=checkAnswers;
  showBtn.onclick =()=>{ play(clickAudio); showAnswers(); };
  resetBtn.onclick=()=>{ play(clickAudio); resetAll(); };

  /* Init */
  initBank();
  initBlanks();
})();
</script>
</body>
</html>
