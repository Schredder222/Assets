<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5" />
<title>Sentence Scramble â€“ Present Perfect Simple 1 (Urban Living)</title>
<style>
  :root{
    --bg:#FDFBED;
    --ink:#111;
    --accent:#8A0000;
    --ok:#1E8E3E;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }

  body{
    margin:0;
    font-family:"MS Reference Sans Serif", Arial, sans-serif;
    background:var(--bg);
    color:var(--ink);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px 14px 48px;
  }

  h1{
    color:#111;                     /* black heading */
    margin:0 0 12px 0;              /* space under title */
    font-size:clamp(20px,3.2vw,28px);
    letter-spacing:.2px;
  }

  .instructions{
    margin:0 0 10px 0;              /* space under instructions */
    font-size:clamp(14px,2.6vw,16px);
    text-align:center;
    max-width:900px;
  }

  /* Top bar: timer + mute (kept on one line; no layout shift) */
  .topbar{
    width:min(1000px,96vw);
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin:8px auto 10px;
    gap:12px;
    flex-wrap:nowrap;       /* never wrap */
    min-height:40px;        /* reserve height to prevent vertical jiggle */
  }
  .timer{
    background:#111; color:#fff; padding:6px 12px; border-radius:999px;
    font-weight:600; letter-spacing:.3px; box-shadow:0 2px 10px rgba(0,0,0,.12);
    font-variant-numeric:tabular-nums;
    white-space:nowrap;
  }
  .muteBtn{
    display:inline-flex; align-items:center; justify-content:center;
    background:transparent; border:none;
    padding:6px; width:40px; height:40px; border-radius:999px;
    cursor:pointer; line-height:0; flex:0 0 auto;

    /* hidden but space-reserved until audio starts */
    visibility:hidden; opacity:0; pointer-events:none;
  }
  .muteBtn--ready{ visibility:visible; opacity:1; pointer-events:auto; }
  .muteBtn:focus-visible{ outline:2px solid #000; outline-offset:2px; }
  .muteBtn img{ width:24px; height:24px; display:block; }

  /* Activity wrap (overlay context) */
  .activity-wrap{
    position:relative;
    width:min(1000px, 96vw);
    margin:0 auto;
  }

  /* Counter centred above the anagram */
  .counter{
    text-align:center;
    font-weight:700;
    font-size:clamp(18px,3.8vw,24px); /* slightly smaller */
    margin:4px 0 6px;
  }

  /* Stage: centred tiles */
  .stage{
    display:flex;
    flex-wrap:wrap;                 /* desktop default */
    gap:10px 12px;
    justify-content:center;
    align-items:center;
    min-height:120px;
    margin:6px auto 10px;
    padding:0;
  }

  .word{
    background:#fff;
    border:1px solid #BDBDBD;
    border-radius:14px;
    padding:14px 16px;               /* desktop padding */
    cursor:grab;
    user-select:none;
    font-weight:bold;
    line-height:1.15;
    box-shadow:0 2px 6px rgba(0,0,0,.06);
    transition:transform .12s ease, box-shadow .12s ease, background-color .15s ease, border-color .15s ease, color .15s ease;
    font-size:clamp(18px,3.6vw,28px);  /* desktop & default */
    touch-action:none; /* smoother touch drag */
  }
  .word:active{ cursor:grabbing; transform:scale(.98) }
  .word.dragging{ opacity:.6 }
  .word.placeholder{ visibility:hidden; } /* keeps layout space while dragging */

  /* Floating ghost for touch drag */
  .drag-ghost{
    position:fixed; left:0; top:0; z-index:9999;
    pointer-events:none; opacity:.95;
    box-shadow:0 6px 18px rgba(0,0,0,.18);
    transform:translate(-9999px,-9999px);
  }

  /* Success state: solid green for 2 seconds */
  .word.success{
    background:#DFF5E3;
    border-color:var(--ok);
    color:#0b4c1c;
  }

  /* Controls row (bottom buttons) */
  .controls{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-top:8px;
  }
  .btn{
    background:var(--accent); color:#fff; border:none;
    padding:10px 16px; border-radius:10px;
    font-weight:600; letter-spacing:.2px; cursor:pointer;
    box-shadow:0 3px 10px rgba(138,0,0,.25);
    transition:background .2s, transform .15s;
  }
  .btn:hover{ transform:translateY(-1px) }
  .btn:active{ transform:translateY(0) scale(.98) }
  .btn.ghost{ background:#eee; color:#111; box-shadow:none; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none; pointer-events:none; }

  /* Fade between items */
  @keyframes fadeIn {
    from { opacity:0; transform:translateY(6px) scale(.985) }
    to   { opacity:1; transform:translateY(0)   scale(1) }
  }
  @keyframes fadeOut {
    from { opacity:1; transform:translateY(0)   scale(1) }
    to   { opacity:0; transform:translateY(-6px) scale(.985) }
  }
  .fade-in{ animation:fadeIn .35s ease forwards }
  .fade-out{ animation:fadeOut .25s ease forwards }

  /* === Congrats overlay (half-size image) === */
  #congratsOverlay{
    position:absolute; inset:0;
    display:none; align-items:center; justify-content:center;
    z-index:99999; pointer-events:none;
  }
  #congratsOverlay[aria-hidden="false"]{ display:flex; }
  #congratsOverlay img{
    width:clamp(160px, 50%, 400px);
    height:auto; animation:none; will-change:transform, opacity;
    border:none; outline:none; box-shadow:none;
  }
  @keyframes congratsZoom{
    0%   { transform: scale(0.70); opacity:0; }
    8%   { opacity:1; }
    100% { transform: scale(1.0); opacity:1; }
  }

  /* ===== Mobile tweaks: single line + tighter boxes ===== */
  @media (max-width:520px){
    .stage{
      flex-wrap:nowrap;            /* force single line on mobile */
      gap:6px;                     /* tighter gaps by default */
      min-height:80px;
      overflow:hidden;             /* hide any tiny overflow before fitting runs */
      justify-content:flex-start;  /* pack from the left so measuring feels natural */
    }
    .word{
      padding:10px 12px;           /* smaller mobile padding; JS may shrink more */
      font-size:18px;              /* base; JS fitting may shrink further */
      border-radius:12px;
    }
    .muteBtn{ width:36px; height:36px; padding:6px; }
    .muteBtn img{ width:22px; height:22px; }
    .timer{ padding:5px 10px; }
    .controls{ justify-content:center; flex-wrap:wrap; } /* centre buttons on mobile */
  }
</style>
</head>
<body>

<h1>Sentence Scramble</h1>
<p class="instructions">
  Unscramble the words to make a correct sentence in <b>Present Perfect</b>.
</p>

<div class="topbar">
  <div class="timer" id="timer">00:00</div>
  <button class="muteBtn" id="muteBtn" aria-pressed="false" aria-label="Mute background music" title="Mute" aria-hidden="true">
    <img id="muteIcon" alt="" src="https://schredder222.github.io/Assets/Unmute.svg" />
  </button>
</div>

<div class="activity-wrap" id="activityWrap">
  <div class="counter" id="counter">1 / 8</div>
  <div class="stage fade-in" id="stage"></div>

  <div class="controls">
    <button class="btn ghost" id="shuffleBtn" type="button">Shuffle anagram</button>
    <button class="btn" id="resetBtn" type="button">Reset activity</button>
  </div>

  <div id="congratsOverlay" aria-hidden="true">
    <img src="https://schredder222.github.io/Assets/OutOfThisWorld!.png" alt="Out of this world!">
  </div>
</div>

<!-- Audio -->
<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2024/02/10/audio_58dac346c5.mp3" loop preload="auto"></audio>
<audio id="sfxCorrect" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_dcde83efa6.mp3?filename=ui_correct_button2-103167.mp3" preload="auto"></audio>
<audio id="applause" src="https://schredder222.github.io/Assets/Applause.mp3" preload="auto"></audio>
<audio id="sfxDrop" src="https://cdn.pixabay.com/download/audio/2025/03/20/audio_99fc376452.mp3?filename=ui-pop-sound-316482.mp3" preload="auto"></audio>
<audio id="sfxShuffle" src="https://cdn.pixabay.com/download/audio/2025/07/30/audio_b3087a581e.mp3" preload="auto"></audio>
<audio id="sfxReset" src="https://cdn.pixabay.com/download/audio/2024/04/21/audio_1b8d3bcd3d.mp3?filename=click-buttons-ui-menu-sounds-effects-button-7-203601.mp3" preload="auto"></audio>

<script>
/* --------------------------
   DATA (A2, Present Perfect; no ever/never)
--------------------------- */
const items = [
  { answer:["I","have","visited","London."] },
  { answer:["She","has","not","lived","in","a","big","city."] },
  { answer:["They","have","moved","to","Melbourne."] },
  { answer:["We","have","not","seen","a","concert","in","the","park."] },
  { answer:["Has","he","taken","the","underground?"] },
  { answer:["The","two","cities","have","had","a","rivalry","since","2000."] },
  { answer:["Have","you","visited","Sydney","or","Melbourne?"] },
  { answer:["My","friends","have","found","an","apartment."] }
];

const stage = document.getElementById('stage');
const counterEl = document.getElementById('counter');
const overlay = document.getElementById('congratsOverlay');

const bgm = document.getElementById('bgm');
const sfxCorrect = document.getElementById('sfxCorrect');
const applause = document.getElementById('applause');
const sfxDrop = document.getElementById('sfxDrop');
const sfxShuffle = document.getElementById('sfxShuffle');
const sfxReset = document.getElementById('sfxReset');

const timerEl = document.getElementById('timer');
const muteBtn = document.getElementById('muteBtn');
const muteIcon = document.getElementById('muteIcon');
const MUTE_ICON_URL   = 'https://schredder222.github.io/Assets/Mute.svg';
const UNMUTE_ICON_URL = 'https://schredder222.github.io/Assets/Unmute.svg';

const shuffleBtn = document.getElementById('shuffleBtn');
const resetBtn   = document.getElementById('resetBtn');

/* volumes */
bgm.volume = 0.25;
sfxCorrect.volume = 1.0;
applause.volume = 1.0;
sfxDrop.volume = 0.8;
sfxShuffle.volume = 1.0;
sfxReset.volume = 1.0;

/* state */
let idx = 0;
let locked = false;
let timerInterval = null;
let elapsedMs = 0;
let startedAt = null;

let hasStartedActivity = false;
let celebrating = false;
let overlayTimeoutId = null;
/* cancel the 2s success-hold when resetting */
let successTimeoutId = null;

/* environment flags */
const IS_COARSE = (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) || ('ontouchstart' in window);

/* guard flags to avoid duplicate listeners */
let desktopBound = false;
let touchBound = false;

/* --------------------------
   HELPERS
--------------------------- */
function shuffled(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function shuffledFromAnswer(ans){
  const target = ans.join(' ');
  for(let tries=0; tries<10; tries++){
    const cand = shuffled(ans);
    if(cand.join(' ') !== target) return cand;
  }
  return shuffled(ans);
}
function fmtTime(totalSec){
  const m = String(Math.floor(totalSec/60)).padStart(2,'0');
  const s = String(totalSec%60).padStart(2,'0');
  return `${m}:${s}`;
}

/* Fit all words on one line for mobile by reducing gap, padding, then font-size */
function fitMobileToOneLine(){
  if (window.innerWidth > 520) { // reset any inline tweaks on desktop/tablet
    stage.style.gap='';
    [...stage.querySelectorAll('.word')].forEach(w=>{
      w.style.fontSize=''; w.style.padding='';
    });
    return;
  }
  const words = [...stage.querySelectorAll('.word')];
  if (!words.length) return;

  // Reset to mobile base before measuring
  stage.style.gap = '6px';
  words.forEach(w=>{ w.style.padding='10px 12px'; w.style.fontSize='18px'; });

  const avail = stage.getBoundingClientRect().width;
  const minGap = 2;
  const minPadX = 6;
  const minFont = 12;

  let gap = 6, padX = 12, padY = 10, font = 18;

  const totalWidth = () => {
    // Ensure layout is up to date
    let sum = 0;
    words.forEach(w => { sum += w.getBoundingClientRect().width; });
    // column gap * (n-1)
    return sum + gap * Math.max(0, words.length - 1);
  };

  // Try shrinking: gaps -> padding -> font
  let guard = 0;
  while (totalWidth() > avail && guard++ < 500){
    if (gap > minGap){ gap -= 1; stage.style.gap = gap + 'px'; continue; }
    if (padX > minPadX){
      padX -= 1;
      words.forEach(w => w.style.padding = `${padY}px ${padX}px`);
      continue;
    }
    if (font > minFont){
      font -= 1;
      words.forEach(w => w.style.fontSize = font + 'px');
      continue;
    }
    break; // can't shrink further
  }
}

/* --------------------------
   TIMER
--------------------------- */
function startTimer(){
  if(timerInterval) return;
  startedAt = performance.now() - elapsedMs;
  timerInterval = setInterval(()=>{
    elapsedMs = performance.now() - startedAt;
    timerEl.textContent = fmtTime(Math.floor(elapsedMs/1000));
  }, 250);
}
function stopTimer(){ clearInterval(timerInterval); timerInterval=null; }

/* --------------------------
   MUSIC + MUTE UI
--------------------------- */
function syncMuteIcon(){
  muteBtn.setAttribute('aria-pressed', String(bgm.muted));
  muteIcon.src = bgm.muted ? MUTE_ICON_URL : UNMUTE_ICON_URL;
  muteBtn.title = bgm.muted ? 'Unmute' : 'Mute';
  muteBtn.setAttribute('aria-label', bgm.muted ? 'Unmute background music' : 'Mute background music');
}
function revealMuteButton(){
  muteBtn.classList.add('muteBtn--ready');
  muteBtn.removeAttribute('aria-hidden');
  syncMuteIcon();
}
muteBtn.addEventListener('click', ()=>{ bgm.muted = !bgm.muted; syncMuteIcon(); });
bgm.addEventListener('playing', revealMuteButton);

/* On first user gesture (drag start), try to start audio immediately */
function startActivityIfNeeded(){
  if(hasStartedActivity) return;
  hasStartedActivity = true;
  try{
    bgm.currentTime = 0;
    const p = bgm.play();
    if (p && typeof p.then === 'function'){ p.catch(()=>{}); }
  }catch(e){}
  startTimer();
}

/* Safety net on mobile: if audio didnâ€™t start on pointerdown, try again on pointerup/click */
let oneTimeUnlock = true;
function tryUnlockOnce(){
  if (!hasStartedActivity) return;
  if (!bgm.paused || bgm.currentTime > 0) {
    window.removeEventListener('pointerup', tryUnlockOnce, {passive:true});
    window.removeEventListener('click', tryUnlockOnce, {passive:true});
    oneTimeUnlock=false; return;
  }
  try {
    const p = bgm.play();
    if (p && typeof p.then === 'function'){ p.catch(()=>{}); }
  } catch {}
  window.removeEventListener('pointerup', tryUnlockOnce, {passive:true});
  window.removeEventListener('click', tryUnlockOnce, {passive:true});
  oneTimeUnlock=false;
}

/* --------------------------
   RENDER & CHECK
--------------------------- */
function renderCurrent(){
  stage.innerHTML = "";
  stage.classList.remove('fade-out'); stage.classList.add('fade-in');
  counterEl.textContent = `${idx+1} / ${items.length}`;

  const tokens = shuffledFromAnswer(items[idx].answer);
  tokens.forEach(token=>{
    const w = document.createElement('div');
    w.className = 'word';
    w.textContent = token;
    /* Enable native HTML5 drag on desktop only */
    w.draggable = !(IS_COARSE);
    stage.appendChild(w);
  });

  // Ensure single-line fit on mobile (reduce gaps/padding/font in that order)
  fitMobileToOneLine();
}

function wordsOf(){ return [...stage.querySelectorAll('.word')]; }
function textArray(){ return wordsOf().map(w=>w.textContent); }
function isCorrect(){ return textArray().join(' ') === items[idx].answer.join(' '); }

/* --------------------------
   CELEBRATION
--------------------------- */
function setControlsDuringCelebration(active){
  shuffleBtn.disabled = active;               // disable "other" buttons; Reset stays enabled
  shuffleBtn.setAttribute('aria-disabled', String(active));
}
function endCelebration(){
  celebrating = false;
  if(overlayTimeoutId){ clearTimeout(overlayTimeoutId); overlayTimeoutId=null; }
  overlay.setAttribute('aria-hidden','true');
  try{ applause.pause(); applause.currentTime=0; }catch(e){}
  setControlsDuringCelebration(false);
}
function showCongrats(){
  const img = overlay.querySelector('img');
  img.style.animation = 'none'; void img.offsetWidth;
  img.style.animation = 'congratsZoom 8s ease-out forwards';
  celebrating = true;
  setControlsDuringCelebration(true);
  overlay.setAttribute('aria-hidden','false');
  try{ applause.currentTime = 0; applause.play(); }catch(e){}
  overlayTimeoutId = setTimeout(()=> endCelebration(), 9000);
}

function markSuccessForTwoSecondsThenNext(){
  wordsOf().forEach(w=>w.classList.add('success'));
  try{ sfxCorrect.currentTime=0; sfxCorrect.play(); }catch(e){}
  locked = true;

  successTimeoutId = setTimeout(()=>{
    successTimeoutId = null;
    if(idx < items.length-1){
      idx++; locked=false; renderCurrent();
      attachTouchDnDIfNeeded();  // ensure handlers exist for new nodes
      bindDesktopDnD();
    }else{
      try{ bgm.pause(); }catch(e){}
      stopTimer();
      timerEl.textContent = `Completed in ${fmtTime(Math.floor(elapsedMs/1000))}`;
      showCongrats();
    }
  }, 2000);
}

/* --------------------------
   DESKTOP DnD (HTML5)
--------------------------- */
function bindDesktopDnD(){
  if(IS_COARSE || desktopBound) return;
  desktopBound = true;

  let dragWord=null;

  document.addEventListener('dragstart', e=>{
    if(locked) return e.preventDefault();
    if(e.target.classList.contains('word')){
      startActivityIfNeeded();                  // no await to keep gesture chain
      if (oneTimeUnlock){
        window.addEventListener('pointerup', tryUnlockOnce, {once:true, passive:true});
        window.addEventListener('click', tryUnlockOnce, {once:true, passive:true});
      }
      dragWord = e.target;
      dragWord.classList.add('dragging');
    }
  }, {passive:false});

  document.addEventListener('dragend', e=>{
    if(e.target.classList.contains('word')){
      e.target.classList.remove('dragging');
      dragWord = null;
    }
  });

  stage.addEventListener('dragover', e=>{
    if(locked) return;
    e.preventDefault();
    const words = wordsOf().filter(n=>n!==dragWord);
    const after = words.find(el => e.clientX < el.getBoundingClientRect().left + el.offsetWidth/2);
    if(after) stage.insertBefore(dragWord, after);
    else stage.appendChild(dragWord);
  });

  document.addEventListener('drop', ()=>{
    if(locked) return;
    try{ sfxDrop.currentTime=0; sfxDrop.play(); }catch(e){}
    if(isCorrect()) markSuccessForTwoSecondsThenNext();
  });
}

/* --------------------------
   TOUCH / POINTER DnD (mobile)
--------------------------- */
function attachTouchDnDIfNeeded(){
  if(!IS_COARSE || touchBound) return;
  touchBound = true;

  let dragging=null;

  function moveGhost(x,y){
    if(!dragging) return;
    dragging.ghost.style.transform = `translate(${Math.round(x-dragging.offX)}px, ${Math.round(y-dragging.offY)}px)`;
  }

  function nearestElementIndex(x,y){
    const items = [...stage.children].filter(el=>el!==dragging.placeholder);
    if(items.length===0) return 0;
    let bestIdx=items.length, bestDist=Infinity, bestEl=null;
    items.forEach((el,i)=>{
      const r = el.getBoundingClientRect();
      const cx = r.left + r.width/2;
      const cy = r.top  + r.height/2;
      const d = (cx-x)*(cx-x) + (cy-y)*(cy-y);
      if(d < bestDist){ bestDist=d; bestEl=el; bestIdx=i; }
    });
    if(!bestEl) return 0;
    const r = bestEl.getBoundingClientRect();
    const before = x < r.left + r.width/2;
    const baseIndex = [...stage.children].indexOf(bestEl);
    return before ? baseIndex : baseIndex+1;
  }

  function insertPlaceholderAt(x,y){
    const targetIndex = nearestElementIndex(x,y);
    const currentIndex = [...stage.children].indexOf(dragging.placeholder);
    if(targetIndex !== currentIndex){
      if(targetIndex >= stage.children.length) stage.appendChild(dragging.placeholder);
      else stage.insertBefore(dragging.placeholder, stage.children[targetIndex]);
    }
  }

  function endTouchDrag(e){
    if(!dragging) return;
    const {tile, ghost, placeholder} = dragging;
    const i = [...stage.children].indexOf(placeholder);
    if(i >= stage.children.length) stage.appendChild(tile);
    else stage.insertBefore(tile, stage.children[i]);
    tile.style.visibility = '';
    ghost.remove();
    placeholder.remove();
    document.body.style.touchAction = '';
    dragging = null;
    try{ sfxDrop.currentTime=0; sfxDrop.play(); }catch(err){}
    if(isCorrect()) markSuccessForTwoSecondsThenNext();
  }

  stage.addEventListener('pointerdown', (e)=>{
    const t = e.target;
    if(!t.classList.contains('word')) return;
    if(locked) return;

    // Start the activity (audio + timer) on first user gesture
    startActivityIfNeeded();                     // no await
    if (oneTimeUnlock){
      window.addEventListener('pointerup', tryUnlockOnce, {once:true, passive:true});
      window.addEventListener('click', tryUnlockOnce, {once:true, passive:true});
    }

    e.preventDefault();

    const rect = t.getBoundingClientRect();
    const ghost = t.cloneNode(true);
    ghost.classList.add('drag-ghost');
    ghost.style.width = rect.width + 'px';
    ghost.style.height = rect.height + 'px';
    document.body.appendChild(ghost);

    const placeholder = document.createElement('div');
    placeholder.className = 'word placeholder';
    placeholder.style.width = rect.width + 'px';
    placeholder.style.height = rect.height + 'px';
    stage.insertBefore(placeholder, t);
    t.style.visibility = 'hidden';

    dragging = {
      tile: t,
      ghost,
      placeholder,
      offX: e.clientX - rect.left,
      offY: e.clientY - rect.top
    };
    moveGhost(e.clientX, e.clientY);
    insertPlaceholderAt(e.clientX, e.clientY);

    document.body.style.touchAction='none';

    const onMove = (ev)=>{
      if(!dragging) return;
      moveGhost(ev.clientX, ev.clientY);
      insertPlaceholderAt(ev.clientX, ev.clientY);
    };
    const onUp = (ev)=>{
      window.removeEventListener('pointermove', onMove, {passive:false});
      window.removeEventListener('pointerup', onUp, {passive:false});
      window.removeEventListener('pointercancel', onUp, {passive:false});
      endTouchDrag(ev);
    };

    window.addEventListener('pointermove', onMove, {passive:false});
    window.addEventListener('pointerup', onUp, {passive:false});
    window.addEventListener('pointercancel', onUp, {passive:false});
  }, {passive:false});
}

/* --------------------------
   BUTTONS
--------------------------- */
function shuffleCurrent(){
  if(locked) return;
  if(isCorrect()) return; // don't shuffle if solved
  try{ sfxShuffle.currentTime=0; sfxShuffle.play(); }catch(e){}
  const nodes = wordsOf();
  const shuffledNodes = nodes.slice().sort(()=>Math.random()-0.5);
  stage.innerHTML = '';
  shuffledNodes.forEach(n=>{
    n.classList.remove('success','dragging');
    n.draggable = !(IS_COARSE);
    stage.appendChild(n);
  });
  fitMobileToOneLine(); // keep single-line fit after shuffle
}

function resetActivity(){
  // Close celebration immediately and stop applause if showing
  if(celebrating) endCelebration();

  // Cancel pending success advance, if any
  if(successTimeoutId){ clearTimeout(successTimeoutId); successTimeoutId = null; }
  locked = false;

  try{ sfxReset.currentTime=0; sfxReset.play(); }catch(e){}

  // Back to the very start (first anagram)
  idx = 0;

  // Reset timer (do not start until first drag)
  stopTimer();
  elapsedMs = 0; startedAt = null;
  timerEl.textContent = '00:00';

  // Reset music (do not play until first drag)
  try{ bgm.pause(); bgm.currentTime = 0; }catch(e){}
  muteBtn.classList.remove('muteBtn--ready');
  muteBtn.setAttribute('aria-hidden','true');

  hasStartedActivity = false;

  setControlsDuringCelebration(false);

  renderCurrent();           // shows anagram 1 (fresh random order)
}

shuffleBtn.addEventListener('click', shuffleCurrent);
resetBtn.addEventListener('click', resetActivity);

/* --------------------------
   INIT
--------------------------- */
renderCurrent();
attachTouchDnDIfNeeded();
bindDesktopDnD();
timerEl.textContent = '00:00';
window.addEventListener('resize', fitMobileToOneLine, {passive:true});
</script>
</body>
</html>
