<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>For vs Since ‚Äî Card Match (A2)</title>
<style>
  :root{
    --bg:#FDFBED; --ink:#222;
    --edge:#B5B5B5;
    --edge-strong:#5f5f5f;
    --ok:#1E8E3E; --bad:#B00020; --muted:#9aa1a8; --card:#fff;

    /* Fills */
    --for-fill:#FFF59D;     /* soft yellow */
    --since-fill:#BBDEFB;   /* soft blue */
    --btn:#961917;          /* red buttons */

    /* Selection ring used in banks and blanks */
    --sel-ring: 0 0 0 3px rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"MS Reference Sans Serif", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .app{
    width:min(900px,100%); display:flex; flex-direction:column; gap:14px;
    position:relative; /* celebration PNG centres over this box */
  }
  header{
    display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px
  }
  h1{font-size:25px; margin:0; display:flex; align-items:center; gap:8px}
  .controls{display:flex; align-items:center; gap:8px}
  button{
    border:2px solid var(--edge); background:#fff; color:#000; padding:6px 10px; border-radius:999px;
    font-weight:600; cursor:pointer; transition:transform .06s ease, background .2s ease, color .2s ease, border-color .2s ease;
  }
  /* Red buttons (exclude mute icon button) */
  header .controls button:not(.muteBtn){ background:var(--btn); border-color:var(--btn); color:#fff; }
  header .controls button:not(.muteBtn):hover{ transform:translateY(-1px); filter:brightness(1.05); }

  .meta{font-size:.9rem; color:#333}
  .muted{color:var(--muted)}

  /* Word banks (shared container) */
  .banks{
    display:flex; gap:16px; flex-wrap:wrap;
    background:#fff; border:1px dashed var(--edge); border-radius:10px; padding:10px;
  }
  .bankWrap{flex:1; min-width:140px}
  .bankTitle{font-weight:700; margin:0 0 4px 0; font-size:.9rem}
  .bank{display:flex; flex-wrap:wrap; gap:6px; min-height:38px}

  /* Word chips */
  .pill{
    display:inline-flex; align-items:center; justify-content:center;
    min-width:56px; padding:5px 10px; border-radius:999px;
    border:2px solid var(--edge); background:#fff; font-weight:700; cursor:pointer;
    transition:box-shadow .15s ease, background .15s ease, border-color .15s ease; user-select:none;
    touch-action: none; -webkit-tap-highlight-color: transparent;
    box-shadow:none;
  }
  .pill[data-value="for"]{ background:var(--for-fill); }
  .pill[data-value="since"]{ background:var(--since-fill); }
  .pill.selected{ box-shadow: var(--sel-ring); }
  /* No inner ring when selected inside a blank; we highlight the blank instead */
  .blank .pill.selected{ box-shadow:none; }

  /* Sentences grid (compact) */
  .grid{display:grid; grid-template-columns:1fr; gap:8px}
  @media (min-width:650px){ .grid{grid-template-columns:1fr 1fr} }
  .card{
    background:var(--card); border:1px solid #ddd; border-radius:8px;
    padding:8px 10px; font-size:1rem; line-height:1.45;
    display:flex; align-items:center; position:relative;
  }
  .sentence{margin:0}

  /* Blank styled to match pills; fixed width prevents layout shift */
  .blank{
    display:inline-flex; align-items:center; justify-content:center;
    width:64px; min-height:34px; padding:3px 10px; margin:0 4px;
    border:2px dashed var(--edge); border-radius:999px;
    background:#fff; vertical-align:middle;
    transition:background .15s ease, border-color .15s ease, outline-color .15s ease, box-shadow .15s ease;
    touch-action: none; -webkit-tap-highlight-color: transparent;
    box-shadow:none;
  }
  .blank.ready{outline:3px solid rgba(0,0,0,.10)}
  .blank.filled{border-style:solid;}
  .blank[data-filled="for"]{ background:var(--for-fill); }
  .blank[data-filled="since"]{ background:var(--since-fill); }
  /* Selected placed-word look = same ring as bank selection */
  .blank.selected{ border-color: var(--edge); box-shadow: var(--sel-ring); }
  .blank.correct{border-color:var(--ok); background:#ecf6ef}
  .blank.incorrect{border-color:var(--bad); background:#faecef}

  /* Chip appearance when sitting inside a blank */
  .blank .pill{
    border:0; background:transparent; padding:0; min-width:auto;
    cursor:grab;
  }

  .resultMark{
    position:absolute; top:6px; right:8px; font-weight:800;
    font-size:.9rem; user-select:none;
  }
  .tick{color:var(--ok)} .cross{color:var(--bad)}

  /* Floating ghost for touch-drag */
  .drag-ghost{
    position:fixed; z-index:9999; transform:translate(-50%,-50%);
    opacity:.95; pointer-events:none;
    border-radius:999px; border:2px solid var(--edge); background:#fff;
    padding:5px 10px; font-weight:700;
  }

  /* PNG-only celebration overlay centred over .app */
  #congratsOverlay{
    position:absolute; inset:0; display:none;
    align-items:center; justify-content:center;
    z-index:1000; pointer-events:none;
  }
  #congratsOverlay img{
    width:clamp(160px,60%,420px); height:auto;
    animation:none; will-change: transform, opacity;
  }
  @keyframes congratsZoom{
    0%{ transform:scale(0.70); opacity:0; }
    8%{ opacity:1; }
    100%{ transform:scale(1.0); opacity:1; }
  }

  /* Score under grid */
  .scoreBelow{
    text-align:center; font-weight:700; margin-top:6px; min-height:1.2em;
  }

  /* ‚Äî‚Äî Mute/unmute button (template) ‚Äî‚Äî */
  .muteBtn{
    visibility:hidden;  /* hidden until first word interaction */
    display:inline-flex;
    background:transparent; border:none; padding:6px;
    width:40px; height:40px; border-radius:999px; cursor:pointer; line-height:0;
  }
  .muteBtn:focus-visible{ outline:2px solid #000; outline-offset:2px; }
  .muteBtn img{ width:24px; height:24px; display:block; }

  /* üì± Mobile: reverse button order to Check ‚Üí Reset ‚Üí Mute */
  @media (max-width:520px){
    .controls{ gap:6px; }
    #btnCheck{ order:1; }
    #btnReset{ order:2; }
    #muteBtn{ order:3; }
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>For vs Since ‚Äî Card Match</h1>
      <div class="controls">
        <!-- Desktop order (Mute ‚Üí Reset ‚Üí Check). Mobile CSS reverses it. -->
        <button class="muteBtn" id="muteBtn" aria-pressed="false" aria-label="Mute background music" title="Mute">
          <img id="muteIcon" alt="" src="https://schredder222.github.io/Assets/Unmute.svg" />
        </button>
        <button id="btnReset">Reset</button>
        <button id="btnCheck">Check answers</button>
      </div>
    </header>

    <div class="meta muted" id="summary">Tap or drag words into the blanks. You can move or swap them. Then press ‚ÄúCheck answers‚Äù.</div>

    <section class="banks">
      <div class="bankWrap">
        <p class="bankTitle">Word bank ‚Äî for</p>
        <div class="bank" id="bankFor"></div>
      </div>
      <div class="bankWrap">
        <p class="bankTitle">Word bank ‚Äî since</p>
        <div class="bank" id="bankSince"></div>
      </div>
    </section>

    <section class="grid" id="grid"></section>
    <div class="scoreBelow" id="scoreBelow"></div>

    <!-- PNG-only celebration centred over the activity -->
    <div id="congratsOverlay" aria-hidden="true">
      <img id="congratsImg" alt="Well done!" />
    </div>
  </div>

  <!-- Background music (loops) -->
  <audio id="bgm" preload="auto" loop src="https://cdn.pixabay.com/download/audio/2025/08/26/audio_a11c576d48.mp3"></audio>

<script>
/* Sentences */
const SENTENCES = [
  { text: "I‚Äôve lived in Dublin ___ 2020.", answer: "since" },
  { text: "She has taken the train to work ___ the last three years.", answer: "for" },
  { text: "They‚Äôve been neighbours on this street ___ 2012.", answer: "since" },
  { text: "We‚Äôve waited at the tram stop ___ half an hour.", answer: "for" },
  { text: "He has worked at the bank ___ Monday.", answer: "since" },
  { text: "I‚Äôve used this bus route ___ a long time.", answer: "for" },
  { text: "The caf√© has been open ___ two hours.", answer: "for" },
  { text: "She has played music at the metro station ___ she was a child.", answer: "since" },
  { text: "We‚Äôve stayed in this city hotel ___ last Friday.", answer: "since" },
  { text: "I‚Äôve had this travel card ___ six months.", answer: "for" }
];

/* Celebration images & applause */
const URLS = {
  perfectImg: "https://schredder222.github.io/Assets/You%20Nailed%20It.png",
  goodImg:    "https://schredder222.github.io/Assets/Not%20Bad.png",
  tryImg:     "https://schredder222.github.io/Assets/Keep%20Practising.png",
  applause:   "https://schredder222.github.io/Assets/Applause.mp3"
};
const SFX = {
  drop:  "https://cdn.pixabay.com/download/audio/2025/03/20/audio_99fc376452.mp3?filename=ui-pop-sound-316482.mp3",
  button:"https://cdn.pixabay.com/download/audio/2024/04/21/audio_1b8d3bcd3d.mp3?filename=click-buttons-ui-menu-sounds-effects-button-7-203601.mp3",
  select:"https://cdn.pixabay.com/download/audio/2025/05/23/audio_ec08d1525d.mp3?filename=click-345983.mp3"
};
function playSfx(url){ try{ const a=new Audio(url); a.play(); }catch(e){} }

/* ‚Äî‚Äî Music (template-style controls) ‚Äî‚Äî */
const bgm = document.getElementById('bgm');
const muteBtn = document.getElementById('muteBtn');
const muteIcon = document.getElementById('muteIcon');
const MUTE_ICON_URL   = 'https://schredder222.github.io/Assets/Mute.svg';
const UNMUTE_ICON_URL = 'https://schredder222.github.io/Assets/Unmute.svg';

let hasBgmStarted = false;        // actual audio started
let hasFirstInteraction = false;  // user has clicked/dragged a word at least once

function syncMuteUI(){
  const muted = bgm.muted;
  muteBtn.setAttribute('aria-pressed', String(muted));
  muteIcon.src = muted ? MUTE_ICON_URL : UNMUTE_ICON_URL;
  muteBtn.title = muted ? 'Unmute' : 'Mute';
  muteBtn.setAttribute('aria-label', muted ? 'Unmute background music' : 'Mute background music');
}
function revealMuteButtonOnce(){
  if (!hasFirstInteraction){
    hasFirstInteraction = true;
    muteBtn.style.visibility = 'visible';
    syncMuteUI();
  }
}
function startBgmOnce(){
  revealMuteButtonOnce();           // show button as soon as first word is interacted with
  if (hasBgmStarted) return;
  try { if (bgm.currentTime !== 0) bgm.currentTime = 0; } catch {}
  bgm.volume = 0.18; // gentle background
  const p = bgm.play();
  if (p?.then){
    p.then(()=>{ hasBgmStarted = true; syncMuteUI(); })
     .catch(()=>{ /* autoplay blocked; button is already visible */ });
  } else {
    hasBgmStarted = true; syncMuteUI();
  }
}
bgm.addEventListener('playing', ()=>{
  if (!hasBgmStarted){ hasBgmStarted = true; revealMuteButtonOnce(); }
});
/* Allow toggling even before music has started */
muteBtn.addEventListener('click', ()=>{
  bgm.muted = !bgm.muted;
  if (!hasFirstInteraction) revealMuteButtonOnce();
  syncMuteUI();
});

/* one-time audio unlock listeners */
const unlockOpts = {once:true, passive:true};
function unlockAudioOnce(){ ['pointerdown','pointerup','touchend','click','keydown'].forEach(t=>document.removeEventListener(t, unlockAudioOnce, unlockOpts)); }
['pointerdown','pointerup','touchend','click'].forEach(t=>document.addEventListener(t, unlockAudioOnce, unlockOpts));
document.addEventListener('keydown', unlockAudioOnce, {once:true});

/* DOM references */
const grid = document.getElementById('grid');
const bankFor = document.getElementById('bankFor');
const bankSince = document.getElementById('bankSince');
const btnReset = document.getElementById('btnReset');
const btnCheck = document.getElementById('btnCheck');
const summaryEl = document.getElementById('summary');
const scoreBelowEl = document.getElementById('scoreBelow');

const overlay = document.getElementById('congratsOverlay');
const congratsImg = document.getElementById('congratsImg');

let state = { selected:null, checked:false };
let applauseAudio = new Audio(URLS.applause);
let hideCongratsId = null;

function shuffle(arr){return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);}

function build(){
  grid.innerHTML = bankFor.innerHTML = bankSince.innerHTML = '';
  state.selected=null; state.checked=false;
  summaryEl.textContent = "Tap or drag words into the blanks. You can move or swap them. Then press ‚ÄúCheck answers‚Äù.";
  btnCheck.disabled=false;
  scoreBelowEl.textContent = "";
  hideCongrats();
  try{ applauseAudio.pause(); applauseAudio.currentTime=0; }catch(e){}

  // sentences
  shuffle([...SENTENCES]).forEach((s)=>{
    const card=document.createElement('div');
    card.className='card';
    const [pre,post]=s.text.split('___');

    const span=document.createElement('span');
    span.className='blank'; span.dataset.answer=s.answer;

    // Tap-to-select/Place/Swap on the whole coloured container
    span.addEventListener('click',()=>tryPlace(span));

    // Desktop drag target
    span.addEventListener('dragover', e=>{ if(state.checked) return; e.preventDefault(); span.classList.add('ready'); e.dataTransfer.dropEffect='move'; });
    span.addEventListener('dragleave', ()=> span.classList.remove('ready'));
    span.addEventListener('drop', e=>{
      if(state.checked) return; e.preventDefault(); span.classList.remove('ready');
      const id = e.dataTransfer.getData('text/id');
      const chip = document.getElementById(id);
      if(chip) placeChip(chip, span);
    });

    const p=document.createElement('p');
    p.className='sentence';
    p.append(pre, span, post||'');
    card.appendChild(p);

    const mark=document.createElement('div'); mark.className='resultMark';
    card.appendChild(mark);

    grid.appendChild(card);
  });

  // banks
  makeBank('for', bankFor, SENTENCES.filter(s=>s.answer==='for').length);
  makeBank('since', bankSince, SENTENCES.filter(s=>s.answer==='since').length);

  // enable desktop dropping back onto banks
  enableBankDnD(bankFor);
  enableBankDnD(bankSince);

  // Music state on rebuild
  try { bgm.pause(); } catch(e){}
  hasBgmStarted = false;
  muteBtn.style.visibility = hasFirstInteraction ? 'visible' : 'hidden';
  syncMuteUI();
}

function makeBank(type,container,count){
  for(let i=0;i<count;i++){
    const chip=document.createElement('div');
    chip.className='pill';
    chip.textContent=type;
    chip.draggable=true;
    chip.dataset.value=type;
    chip.id = `chip-${type}-${i}-${Math.random().toString(36).slice(2)}`;

    // CLICK behaviour:
    chip.addEventListener('click',(e)=>{
      e.stopPropagation();
      if(state.checked) return;

      // start bgm/show button on first word click
      startBgmOnce();

      const inBlank = chip.closest('.blank');

      if(inBlank){
        // If another chip is selected, place/swap it into this same blank
        if(state.selected && state.selected!==chip){
          const oldB = state.selected.closest && state.selected.closest('.blank');
          if (oldB) oldB.classList.remove('selected');
          placeChip(state.selected, inBlank);
          return;
        }
        // toggle selection of this placed chip (ring on the blank)
        if(state.selected && state.selected!==chip){
          state.selected.classList.remove('selected');
          const oldB = state.selected.closest && state.selected.closest('.blank');
          if (oldB) oldB.classList.remove('selected');
        }
        chip.classList.toggle('selected');
        if (chip.classList.contains('selected')) {
          inBlank.classList.add('selected');   // ring on container
          state.selected = chip;
          playSfx(SFX.select);
        } else {
          inBlank.classList.remove('selected');
          state.selected = null;
        }
        return;
      }

      // Chip in a bank
      if(state.selected && state.selected!==chip){
        const oldB = state.selected.closest && state.selected.closest('.blank');
        if (oldB) oldB.classList.remove('selected');
        state.selected.classList.remove('selected');
      }
      chip.classList.toggle('selected');
      state.selected = chip.classList.contains('selected') ? chip : null;
      if(state.selected===chip) playSfx(SFX.select);
    });

    // Desktop drag source
    chip.addEventListener('dragstart', e=>{
      if(state.checked){ e.preventDefault(); return; }
      startBgmOnce(); // start/reveal on first drag (desktop)

      chip.classList.add('selected');
      const oldB = state.selected?.closest && state.selected.closest('.blank');
      if (oldB) oldB.classList.remove('selected');

      state.selected = chip;
      e.dataTransfer.setData('text/id', chip.id);
      e.dataTransfer.effectAllowed='move';
    });
    chip.addEventListener('dragend', ()=> chip.classList.remove('selected'));

    // Mobile touch-drag (robust start/reveal for iOS)
    addTouchDrag(chip);

    container.appendChild(chip);
  }
}

function enableBankDnD(container){
  container.addEventListener('dragover', e=>{ if(state.checked) return; e.preventDefault(); e.dataTransfer.dropEffect='move'; });
  container.addEventListener('drop', e=>{
    if(state.checked) return; e.preventDefault();
    const id = e.dataTransfer.getData('text/id');
    const chip = document.getElementById(id);
    if(!chip) return;
    sendToBank(chip, container);
  });
}

/* Tap-to-place / select-on-container helper */
function tryPlace(blank){
  if(state.checked) return;

  const hasChip = blank.querySelector('.pill');

  // If nothing is selected yet and this blank has a chip ‚Üí select it by clicking container
  if(!state.selected && hasChip){
    // clear any other selected blank
    document.querySelectorAll('.blank.selected').forEach(b=>b.classList.remove('selected'));
    hasChip.classList.add('selected');
    blank.classList.add('selected');          // ring same as bank
    state.selected = hasChip;
    playSfx(SFX.select);
    return;
  }

  // If clicking the same blank that holds the selected chip ‚Üí deselect
  if(state.selected && hasChip === state.selected){
    state.selected.classList.remove('selected');
    blank.classList.remove('selected');
    state.selected = null;
    return;
  }

  // Otherwise, if a chip is selected, try to place/swap it into this blank
  if(state.selected){
    placeChip(state.selected, blank);
  }
  // If no selection and empty blank, do nothing
}

/* Move a chip back to a bank */
function sendToBank(chip, container){
  const oldParent = chip.parentElement;
  container.appendChild(chip);
  if(state.selected===chip) state.selected=null;
  chip.classList.remove('selected');
  if(oldParent && oldParent.classList && oldParent.classList.contains('blank')){
    oldParent.classList.remove('selected','filled','correct','incorrect');
    oldParent.removeAttribute('data-filled');
    const mark = oldParent.closest('.card').querySelector('.resultMark'); if(mark) mark.textContent='';
  }
}

/* Core placement (tap + drag + swap) */
function placeChip(chip, blank){
  if(state.checked) return;

  // Clear any existing selection/highlight
  document.querySelectorAll('.blank.selected').forEach(b=>b.classList.remove('selected'));
  if(state.selected){ state.selected.classList.remove('selected'); state.selected=null; }

  const destCard = blank.closest('.card');
  if(destCard){ const mk = destCard.querySelector('.resultMark'); if(mk) mk.textContent=''; }

  const existing = blank.querySelector('.pill');
  const src = chip.parentElement;

  if(src === blank) return;
  if(existing && existing.dataset.value === chip.dataset.value) return;

  // SWAP if destination has a chip and source is another blank
  if(existing && src && src.classList && src.classList.contains('blank')){
    [src, blank].forEach(b=>{
      b.classList.remove('selected','correct','incorrect');
      const mk = b.closest('.card').querySelector('.resultMark'); if(mk) mk.textContent='';
    });
    src.appendChild(existing);
    blank.appendChild(chip);
    src.classList.add('filled'); blank.classList.add('filled');
    src.setAttribute('data-filled', existing.dataset.value);
    blank.setAttribute('data-filled', chip.dataset.value);
    playSfx(SFX.drop);
    return;
  }

  // If destination has a chip and source is NOT a blank (from bank), send existing back to its bank
  if(existing){
    (existing.dataset.value==='for'?bankFor:bankSince).appendChild(existing);
  }

  // if moving from another blank (and not swapping), tidy the source blank
  if(src && src.classList && src.classList.contains('blank')){
    src.classList.remove('selected','filled','correct','incorrect');
    src.removeAttribute('data-filled');
    const mk2 = src.closest('.card').querySelector('.resultMark'); if(mk2) mk2.textContent='';
  }

  blank.appendChild(chip);
  blank.classList.add('filled');
  blank.setAttribute('data-filled', chip.dataset.value);

  playSfx(SFX.drop);
}

/* Check answers ‚Äî marks all cards, shows score, stops bgm, and shows PNG */
btnCheck.addEventListener('click', ()=>{
  playSfx(SFX.button);
  if(state.checked) return;

  // Stop background music on check
  try { bgm.pause(); } catch(e){}
  hasBgmStarted = false;

  // clear any selection and highlight
  if(state.selected){ state.selected.classList.remove('selected'); state.selected=null; }
  document.querySelectorAll('.blank.selected').forEach(b=>b.classList.remove('selected'));

  let correct = 0;
  const blanks = document.querySelectorAll('.blank');

  blanks.forEach(b => {
    const card = b.closest('.card');
    const mark = card ? card.querySelector('.resultMark') : null;
    b.classList.remove('correct','incorrect');
    if (mark) mark.textContent = '';

    const chip = b.querySelector('.pill');
    if (chip && chip.dataset.value === b.dataset.answer) {
      b.classList.add('correct');
      if (mark) mark.innerHTML = '<span class="tick">‚úì</span>';
      correct++;
    } else {
      b.classList.add('incorrect');
      if (mark) mark.innerHTML = '<span class="cross">‚úó</span>';
    }
  });

  scoreBelowEl.textContent = `Score: ${correct} / ${blanks.length}`;
  state.checked = true;
  btnCheck.disabled = true;

  showCelebration(correct, blanks.length);
});

/* Celebration logic: PNG only with zoom animation and 6s timeout */
function showCelebration(correct, total){
  let src = URLS.tryImg;
  if (correct === total){
    src = URLS.perfectImg;
    try{ applauseAudio = new Audio(URLS.applause); applauseAudio.play().catch(()=>{}); }catch(e){}
  } else if (correct >= 7){
    src = URLS.goodImg;
    try{ applauseAudio.pause(); applauseAudio.currentTime=0; }catch(e){}
  } else {
    src = URLS.tryImg;
    try{ applauseAudio.pause(); applauseAudio.currentTime=0; }catch(e){}
  }

  congratsImg.src = src;
  congratsImg.alt = "Result";
  congratsImg.style.animation='none'; void congratsImg.offsetWidth;
  congratsImg.style.animation='congratsZoom 6s ease-out forwards';

  overlay.style.display='flex';
  overlay.setAttribute('aria-hidden','false');

  if (hideCongratsId) { clearTimeout(hideCongratsId); }
  hideCongratsId = setTimeout(hideCongrats, 6000);
}

function hideCongrats(){
  overlay.style.display='none';
  overlay.setAttribute('aria-hidden','true');
  if (hideCongratsId){ clearTimeout(hideCongratsId); hideCongratsId=null; }
  try { applauseAudio.pause(); applauseAudio.currentTime = 0; } catch(e){}
}

/* Reset */
btnReset.addEventListener('click', ()=>{
  playSfx(SFX.button);
  build();
});

/* ---------- Touch-drag fallback (mobile) ---------- */
function addTouchDrag(chip){
  let dragging=false, ghost=null, startX=0, startY=0, lastBlank=null, lastBank=null;

  const onStart = (e)=>{
    if(state.checked) return;
    startBgmOnce(); // start/reveal on first touch

    const t = e.touches && e.touches[0];
    if(!t) return;
    startX = t.clientX; startY = t.clientY;
    dragging=false; lastBlank=null; lastBank=null;

    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend', onEnd, {passive:false});
  };

  const onMove = (e)=>{
    const t = e.touches && e.touches[0];
    if(!t) return;
    const dx = t.clientX - startX, dy = t.clientY - startY;

    if(!dragging && (Math.abs(dx) > 6 || Math.abs(dy) > 6)){
      dragging = true;
      startBgmOnce(); // retry on first movement (iOS)

      chip.classList.add('selected');
      document.querySelectorAll('.blank.selected').forEach(b=>b.classList.remove('selected'));
      state.selected = chip;

      ghost = document.createElement('div');
      ghost.className = 'drag-ghost';
      ghost.textContent = chip.dataset.value;
      document.body.appendChild(ghost);
    }

    if(dragging){
      e.preventDefault(); // stop page scroll while dragging
      ghost.style.left = t.clientX + 'px';
      ghost.style.top  = t.clientY + 'px';

      const el = document.elementFromPoint(t.clientX, t.clientY);
      const b = el ? el.closest('.blank') : null;
      if(b !== lastBlank){
        if(lastBlank) lastBlank.classList.remove('ready');
        if(b) b.classList.add('ready');
        lastBlank = b;
      }
      lastBank = el ? el.closest('.bank') : null;
    }
  };

  const onEnd = (e)=>{
    startBgmOnce(); // final retry on release

    document.removeEventListener('touchmove', onMove, {passive:false});
    document.removeEventListener('touchend', onEnd, {passive:false});

    if(lastBlank) lastBlank.classList.remove('ready');
    if(ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
    ghost=null;

    if(dragging){
      if(lastBlank){
        placeChip(chip, lastBlank);
      }else if(lastBank){
        sendToBank(chip, lastBank);
      }
      chip.classList.remove('selected');
      if(state.selected===chip) state.selected=null;
    }
    dragging=false; lastBlank=null; lastBank=null;
  };

  chip.addEventListener('touchstart', onStart, {passive:true});
}

/* Init */
build();
</script>
</body>
</html>
